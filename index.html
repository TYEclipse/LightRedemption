<!DOCTYPE html>
<html lang="zh-CN">
<!-- This is a ONE FILE WEB GAME ! -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>丐版原神：光之救赎</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.5);
            background: linear-gradient(to bottom, #0f3460, #1a1a2e);
            transition: background 1s ease;
        }

        #story-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(10, 15, 35, 0.95);
            z-index: 10;
            padding: 30px;
            text-align: center;
        }

        #story-screen h1 {
            font-size: 48px;
            margin-bottom: 30px;
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
            letter-spacing: 3px;
        }

        #story-text {
            font-size: 20px;
            line-height: 1.8;
            max-width: 700px;
            margin-bottom: 40px;
            color: #e0e0e0;
        }

        #start-btn {
            padding: 15px 50px;
            font-size: 22px;
            background: linear-gradient(to right, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        #start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.6);
            background: linear-gradient(to right, #4cc9f0, #4361ee);
        }

        #game-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
        }

        #game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 5;
        }

        #score {
            font-size: 24px;
            margin-bottom: 10px;
            color: #f72585;
            text-shadow: 0 0 5px rgba(247, 37, 133, 0.7);
        }

        #level {
            font-size: 20px;
            color: #4cc9f0;
            margin-bottom: 10px;
        }

        #energy-container {
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        #energy-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #4361ee, #4cc9f0);
            transition: width 0.3s;
        }

        #energy-text {
            font-size: 16px;
            color: #ffd166;
        }

        #player {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.8);
            z-index: 3;
            transition: transform 0.2s;
        }

        .fragment {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #ffd166, #ff9e00);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 209, 102, 0.8);
            animation: pulse 1.5s infinite alternate;
            z-index: 2;
        }

        .enemy {
            position: absolute;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #f72585, #7209b7);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(247, 37, 133, 0.7);
            z-index: 2;
        }

        .bullet {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4cc9f0;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.8);
            z-index: 1;
        }

        #game-over,
        #victory {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 35, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        #game-over h2,
        #victory h2 {
            font-size: 60px;
            margin-bottom: 20px;
            color: #f72585;
            text-shadow: 0 0 10px rgba(247, 37, 133, 0.7);
        }

        #victory h2 {
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }

        #final-score {
            font-size: 36px;
            margin-bottom: 30px;
            color: #ffd166;
        }

        #restart-btn {
            padding: 15px 40px;
            font-size: 22px;
            background: linear-gradient(to right, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.6);
            background: linear-gradient(to right, #4cc9f0, #4361ee);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.2);
            }
        }

        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #ffd166;
            text-shadow: 0 0 10px rgba(255, 209, 102, 0.8);
            animation: levelUp 1.5s forwards;
            display: none;
            z-index: 5;
        }

        @keyframes levelUp {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        #level-up-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 35, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        #level-up-screen h2 {
            font-size: 48px;
            margin-bottom: 30px;
            color: #ffd166;
            text-shadow: 0 0 10px rgba(255, 209, 102, 0.8);
        }

        #card-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 0 20px;
        }

        .card {
            width: 200px;
            height: 300px;
            background: linear-gradient(145deg, #1f2a4d, #16213e);
            border: 2px solid #4cc9f0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 30px rgba(76, 201, 240, 0.4);
            border-color: #ffd166;
        }

        .card h3 {
            color: #4cc9f0;
            margin-bottom: 15px;
        }

        .card .upgrade {
            color: #a9dfd8;
            font-size: 16px;
            margin-bottom: 25px;
            min-height: 60px;
        }

        .card .downgrade {
            color: #f7a2b0;
            font-size: 14px;
            min-height: 50px;
        }

        .card-divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            margin: 15px 0;
        }

        #fps-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 16px;
            color: #4cc9f0;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- 开始界面 -->
        <div id="story-screen">
            <h1>丐版原神：光之救赎</h1>
            <div id="story-text">
                <p>在遥远的提瓦特大陆，黑暗势力"暗渊教团"释放了吞噬光明的力量，整个世界陷入黑暗。</p>
                <p>你作为被选中的"光之旅行者"，肩负着收集散落的光之碎片、拯救世界的使命。</p>
                <p>使用方向键移动角色收集金色碎片，但要小心暗渊教团派出的追猎者！</p>
                <p>每收集10个碎片，你的力量就会增强，但追猎者也会变得更加强大和敏捷。</p>
                <p>收集100个光之碎片，你就能净化黑暗，恢复提瓦特的光明！</p>
            </div>
            <button id="start-btn">开始冒险</button>
        </div>

        <!-- 游戏界面 -->
        <div id="game-screen">
            <div id="game-ui">
                <div id="score">碎片: 0</div>
                <div id="level">难度: 1</div>
                <div id="energy-container">
                    <div id="energy-bar" style="width: 100%;"></div>
                </div>
                <div id="energy-text">能量: 100%</div>
            </div>
            <div id="fps-counter">FPS: 0</div>
            <!-- 新增Canvas用于游戏绘制 -->
            <canvas id="game-canvas" width="800" height="600"
                style="position:absolute;top:0;left:0;z-index:2;"></canvas>
            <!-- <div id="level-up" class="level-up">难度提升!</div> -->
        </div>

        <!-- 升级选择界面 -->
        <div id="level-up-screen">
            <h2>力量涌动，请选择你的进化！</h2>
            <div id="card-container">
                <!-- 卡片将由JS动态生成 -->
            </div>
        </div>

        <!-- 游戏结束界面 -->
        <div id="game-over">
            <h2>任务失败</h2>
            <div id="final-score">收集碎片: 0</div>
            <p>暗渊教团的力量太过强大...</p>
            <button id="restart-btn">重新开始</button>
        </div>

        <!-- 胜利界面 -->
        <div id="victory">
            <h2>任务完成!</h2>
            <div id="final-score">收集碎片: 0</div>
            <p>你成功净化了黑暗，提瓦特大陆重获光明！</p>
            <button id="restart-btn">再玩一次</button>
        </div>
    </div>

    <script>
        // 游戏元素
        const gameContainer = document.getElementById('game-container');
        const storyScreen = document.getElementById('story-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over');
        const victoryScreen = document.getElementById('victory');
        const startBtn = document.getElementById('start-btn');
        const restartBtns = document.querySelectorAll('#restart-btn');
        const scoreDisplay = document.getElementById('score');
        const levelDisplay = document.getElementById('level');
        // const levelUpDisplay = document.getElementById('level-up');
        const levelUpScreen = document.getElementById('level-up-screen');
        const cardContainer = document.getElementById('card-container');
        const energyBar = document.getElementById('energy-bar');
        const energyText = document.getElementById('energy-text');
        const fpsCounter = document.getElementById('fps-counter');
        const finalScoreDisplay = document.getElementById('final-score');

        // 游戏变量
        const gameWidth = 800;
        const gameHeight = 600;
        let playerX = 400;
        let playerY = 300;
        let playerSpeed = 6;
        let bulletSpeed = 8;
        let bulletFireRate = 30; // 值越小发射越快
        let score = 0;
        let level = 1;
        let energy = 100;
        let fragments = [];
        let enemies = [];
        let enemyBaseSpeed = 1.0;
        let enemySpawnRate = 150; // 值越小生成越快
        let bullets = [];
        let keys = {};
        let gameRunning = false;
        let gamePaused = false; // 新增游戏暂停状态
        let fragmentSpawnTimer = 0;
        let enemySpawnTimer = 0;
        let bulletSpawnTimer = 0;
        let lastFrameTime = 0;
        let fps = 0;

        // 对象池
        const fragmentPool = [];
        const enemyPool = [];
        const bulletPool = [];

        // 初始化游戏
        function initGame() {
            playerX = 400;
            playerY = 300;
            playerSpeed = 6;
            bulletSpeed = 8;
            bulletFireRate = 30;
            score = 0;
            level = 1;
            energy = 100;
            enemyBaseSpeed = 1.0;
            enemySpawnRate = 150;
            fragments = [];
            enemies = [];
            bullets = [];
            keys = {};
            bulletSpawnTimer = bulletFireRate + 1; // 让第一次 gameLoop 不会立即生成子弹
            enemySpawnTimer = 0;
            fragmentSpawnTimer = 0;
            lastFrameTime = 0;
            activeUpgrades = {};

            // 清空游戏元素
            clearGameElements();
            clearAllDomElementsByClass(['fragment', 'enemy', 'bullet']);

            // 更新UI
            scoreDisplay.textContent = `碎片: ${score}`;
            levelDisplay.textContent = `难度: ${level}`;
            updateEnergyBar();
            // player.style.left = playerX + 'px';
            // player.style.top = playerY + 'px';
            updateBackground();

            // 生成
        }

        function clearAllDomElementsByClass(classes) {
            classes.forEach(cls => {
                const els = gameScreen.querySelectorAll('.' + cls);
                els.forEach(el => el.remove());
            });
        }

        // 清空游戏元素
        function clearGameElements() {
            // 清空碎片
            for (let i = fragments.length - 1; i >= 0; i--) {
                const frag = fragments[i];
                if (frag.element.style.display !== 'none') {
                    frag.element.style.display = 'none';
                }
                fragmentPool.push(frag);
            }
            fragments = [];

            // 清空敌人
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.element.style.display !== 'none') {
                    enemy.element.style.display = 'none';
                }
                enemyPool.push(enemy);
            }
            enemies = [];

            // 清空子弹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                if (bullet.element.style.display !== 'none') {
                    bullet.element.style.display = 'none';
                }
                bulletPool.push(bullet);
            }
            bullets = [];
        }

        // 生成碎片
        function spawnFragment() {
            let fragment;
            if (fragmentPool.length > 0) {
                fragment = fragmentPool.pop();
                fragment.element.style.display = 'block'; // 复用时显示
            } else {
                const element = document.createElement('div');
                element.className = 'fragment';
                gameScreen.appendChild(element);
                fragment = {
                    element: element,
                    x: 0,
                    y: 0
                };
            }

            // 随机位置（确保不会太靠近玩家）
            let x, y;
            do {
                x = Math.random() * (gameWidth - 30);
                y = Math.random() * (gameHeight - 30);
            } while (Math.abs(x - playerX) < 100 && Math.abs(y - playerY) < 100);

            fragment.x = x;
            fragment.y = y;
            fragment.element.style.left = x + 'px';
            fragment.element.style.top = y + 'px';
            fragment.element.style.display = 'block';

            fragments.push(fragment);
        }

        // 生成敌人
        function spawnEnemy() {
            let enemy;
            if (enemyPool.length > 0) {
                enemy = enemyPool.pop();
                enemy.element.style.display = 'block'; // 复用时显示
            } else {
                const element = document.createElement('div');
                element.className = 'enemy';
                gameScreen.appendChild(element);
                enemy = {
                    element: element,
                    x: 0,
                    y: 0,
                    speed: 1
                };
            }

            // 从屏幕边缘生成
            const side = Math.floor(Math.random() * 4);
            let x, y;

            switch (side) {
                case 0: // 上边
                    x = Math.random() * gameWidth;
                    y = -40;
                    break;
                case 1: // 右边
                    x = gameWidth + 40;
                    y = Math.random() * gameHeight;
                    break;
                case 2: // 下边
                    x = Math.random() * gameWidth;
                    y = gameHeight + 40;
                    break;
                case 3: // 左边
                    x = -40;
                    y = Math.random() * gameHeight;
                    break;
            }

            enemy.x = x;
            enemy.y = y;
            enemy.speed = enemyBaseSpeed; // 移除基于等级的速度加成
            enemy.element.style.left = x + 'px';
            enemy.element.style.top = y + 'px';
            enemy.element.style.display = 'block';

            enemies.push(enemy);
        }

        // 生成子弹
        function spawnBullet() {
            if (energy < 15) return;
            let bullet;
            if (bulletPool.length > 0) {
                bullet = bulletPool.pop();
                bullet.element.style.display = 'block'; // 复用时显示
            } else {
                const element = document.createElement('div');
                element.className = 'bullet';
                gameScreen.appendChild(element);
                bullet = {
                    element: element,
                    x: playerX + 20,
                    y: playerY + 20,
                    dx: 0,
                    dy: 0,
                    speed: bulletSpeed,
                    life: 0
                };
            }
            // 找到最近的敌人
            let closestEnemy = null;
            let minDistance = Infinity;
            for (const enemy of enemies) {
                const dx = enemy.x - playerX;
                const dy = enemy.y - playerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestEnemy = enemy;
                }
            }
            if (!closestEnemy) return;
            // 计算子弹方向
            const dx = closestEnemy.x - playerX;
            const dy = closestEnemy.y - playerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance === 0) return; // 防止除零
            bullet.x = playerX + 20;
            bullet.y = playerY + 20;
            bullet.dx = dx / distance;
            bullet.dy = dy / distance;
            bullet.speed = bulletSpeed;
            bullet.life = 0;
            bullet.element.style.left = bullet.x + 'px';
            bullet.element.style.top = bullet.y + 'px';
            bullet.element.style.display = 'block';
            bullets.push(bullet);
            // 消耗能量
            energy -= 15;
            updateEnergyBar();
        }

        // 更新背景（根据难度）
        function updateBackground() {
            const hue = 200 + level * 5;
            gameContainer.style.background = `linear-gradient(to bottom, hsl(${hue}, 70%, 20%), hsl(${hue + 20}, 70%, 10%))`;
        }

        // 更新能量条
        function updateEnergyBar() {
            energyBar.style.width = Math.min(energy, 100) + '%'; // 限制最大宽度为100%
            energyText.textContent = `能量: ${Math.round(energy)}%`;
        }

        // 碰撞检测（使用距离平方优化）
        function checkCollision(x1, y1, r1, x2, y2, r2) {
            const dx = x1 - x2;
            const dy = y1 - y2;
            const distanceSquared = dx * dx + dy * dy;
            const radiusSum = r1 + r2;
            return distanceSquared < radiusSum * radiusSum;
        }

        // ------------------ 卡片系统 ------------------

        const upgrades = [
            { id: 'playerSpeed', text: '提升移动速度 10%', apply: () => { playerSpeed *= 1.10; } },
            { id: 'fireRate', text: '提升攻击速度 15%', apply: () => { bulletFireRate = Math.max(5, bulletFireRate * 0.85); } },
            { id: 'bulletSpeed', text: '提升子弹速度 15%', apply: () => { bulletSpeed *= 1.15; } },
            { id: 'energyOnKill', text: '击败敌人时恢复 5 点能量', apply: () => { /* 特殊逻辑在碰撞中处理 */ } },
            { id: 'fragmentValue', text: '每个碎片额外恢复 5 点能量', apply: () => { /* 特殊逻辑在碰撞中处理 */ } }
        ];

        const downgrades = [
            { id: 'enemySpeed', text: '所有敌人移速提升 8%', apply: () => { enemyBaseSpeed *= 1.08; } },
            { id: 'enemySpawn', text: '敌人生成速度加快 10%', apply: () => { enemySpawnRate = Math.max(20, enemySpawnRate * 0.90); } },
            { id: 'enemyHealth', text: '敌人变得更难被子弹击中', apply: () => { /* 暂不实现，作为占位符 */ } },
            { id: 'energyDrain', text: '能量消耗速度增加 15%', apply: () => { /* 暂不实现，作为占位符 */ } },
            { id: 'lessFragment', text: '碎片生成数量减少', apply: () => { /* 特殊逻辑在生成时处理 */ } }
        ];

        let activeUpgrades = {};

        function handleLevelUp() {
            gamePaused = true;
            level++;
            levelDisplay.textContent = `难度: ${level}`;
            updateBackground();
            generateCards();
            levelUpScreen.style.display = 'flex';
        }

        function generateCards() {
            cardContainer.innerHTML = '';
            const usedUpgradeIds = new Set();
            const usedDowngradeIds = new Set();

            for (let i = 0; i < 3; i++) {
                let upgrade, downgrade;

                // 选择不重复的增益
                do {
                    upgrade = upgrades[Math.floor(Math.random() * upgrades.length)];
                } while (usedUpgradeIds.has(upgrade.id));
                usedUpgradeIds.add(upgrade.id);

                // 选择不重复的减益
                do {
                    downgrade = downgrades[Math.floor(Math.random() * downgrades.length)];
                } while (usedDowngradeIds.has(downgrade.id));
                usedDowngradeIds.add(downgrade.id);

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>进化路线 ${i + 1}</h3>
                    <div class="upgrade"><strong>增益:</strong> ${upgrade.text}</div>
                    <div class="card-divider"></div>
                    <div class="downgrade"><strong>代价:</strong> ${downgrade.text}</div>
                `;

                card.addEventListener('click', () => selectCard(upgrade, downgrade));
                cardContainer.appendChild(card);
            }
        }

        function selectCard(upgrade, downgrade) {
            // 应用效果
            upgrade.apply();
            downgrade.apply();

            // 记录特殊效果
            if (upgrade.id === 'energyOnKill' || upgrade.id === 'fragmentValue') {
                activeUpgrades[upgrade.id] = true;
            }
            if (downgrade.id === 'lessFragment') {
                activeUpgrades[downgrade.id] = true;
            }


            // 关闭选择界面并继续游戏
            levelUpScreen.style.display = 'none';
            gamePaused = false;
            requestAnimationFrame(gameLoop);
        }


        // Canvas元素
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Canvas绘制函数
        function drawPlayer() {
            ctx.save();
            ctx.beginPath();
            ctx.arc(playerX + 20, playerY + 20, 20, 0, Math.PI * 2);
            ctx.fillStyle = ctx.createLinearGradient(playerX, playerY, playerX + 40, playerY + 40);
            ctx.fillStyle.addColorStop(0, '#4361ee');
            ctx.fillStyle.addColorStop(1, '#3a0ca3');
            ctx.shadowColor = 'rgba(67,97,238,0.8)';
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.restore();
        }

        function drawFragments() {
            fragments.forEach(frag => {
                ctx.save();
                ctx.beginPath();
                ctx.arc(frag.x + 12.5, frag.y + 12.5, 12.5, 0, Math.PI * 2);
                ctx.fillStyle = ctx.createRadialGradient(frag.x + 12.5, frag.y + 12.5, 5, frag.x + 12.5, frag.y + 12.5, 12.5);
                ctx.fillStyle.addColorStop(0, '#ffd166');
                ctx.fillStyle.addColorStop(1, '#ff9e00');
                ctx.shadowColor = 'rgba(255,209,102,0.8)';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.restore();
            });
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.save();
                ctx.beginPath();
                ctx.rect(enemy.x, enemy.y, 35, 35);
                ctx.fillStyle = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x + 35, enemy.y + 35);
                ctx.fillStyle.addColorStop(0, '#f72585');
                ctx.fillStyle.addColorStop(1, '#7209b7');
                ctx.shadowColor = 'rgba(247,37,133,0.7)';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.restore();
            });
        }

        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.save();
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#4cc9f0';
                ctx.shadowColor = 'rgba(76,201,240,0.8)';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.restore();
            });
        }

        // 游戏主循环
        function gameLoop(timestamp) {
            if (!gameRunning || gamePaused) { // 检查暂停状态
                // 游戏结束时清空所有按键状态
                if (!gameRunning) keys = {};
                return;
            }

            // 计算FPS
            if (lastFrameTime > 0) {
                const deltaTime = timestamp - lastFrameTime;
                fps = Math.round(1000 / deltaTime);
                fpsCounter.textContent = `FPS: ${fps}`;
            }
            lastFrameTime = timestamp;

            // 移动玩家
            if (keys['ArrowUp'] && playerY > 0) playerY -= playerSpeed;
            if (keys['ArrowDown'] && playerY < gameHeight - 40) playerY += playerSpeed;
            if (keys['ArrowLeft'] && playerX > 0) playerX -= playerSpeed;
            if (keys['ArrowRight'] && playerX < gameWidth - 40) playerX += playerSpeed;

            // player.style.left = playerX + 'px';
            // player.style.top = playerY + 'px';

            // 自动发射子弹
            bulletSpawnTimer++;
            if (bulletSpawnTimer > bulletFireRate) { // 使用变量控制发射速率
                spawnBullet();
                bulletSpawnTimer = 0;
            }

            // 更新碎片
            for (let i = fragments.length - 1; i >= 0; i--) {
                const frag = fragments[i];

                // 检测碰撞
                if (checkCollision(playerX + 20, playerY + 20, 20,
                    frag.x + 12.5, frag.y + 12.5, 12.5)) {
                    // 收集碎片
                    frag.element.style.display = 'none';
                    fragments.splice(i, 1);
                    fragmentPool.push(frag);

                    score++;
                    scoreDisplay.textContent = `碎片: ${score}`;

                    // 恢复能量
                    let energyGain = activeUpgrades['fragmentValue'] ? 15 : 10;
                    energy = Math.min(100, energy + energyGain);
                    updateEnergyBar();

                    // 每10个碎片提升难度
                    if (score > 0 && score % 10 === 0) {
                        handleLevelUp();
                        return; // 暂停游戏循环，等待玩家选择
                    }

                    // 检查胜利条件
                    if (score >= 100) {
                        gameRunning = false;
                        finalScoreDisplay.textContent = `收集碎片: ${score}`;
                        victoryScreen.style.display = 'flex';
                        return;
                    }
                }
            }

            // 更新敌人
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];

                // 向玩家移动
                const dx = playerX - enemy.x;
                const dy = playerY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                enemy.x += (dx / distance) * enemy.speed;
                enemy.y += (dy / distance) * enemy.speed;

                enemy.element.style.left = enemy.x + 'px';
                enemy.element.style.top = enemy.y + 'px';

                // 检测碰撞
                if (checkCollision(playerX + 20, playerY + 20, 20,
                    enemy.x + 17.5, enemy.y + 17.5, 17.5)) {
                    // 游戏结束
                    gameRunning = false;
                    finalScoreDisplay.textContent = `收集碎片: ${score}`;
                    gameOverScreen.style.display = 'flex';
                    return;
                }

                // 移除屏幕外的敌人
                if (enemy.x < -50 || enemy.x > gameWidth + 50 ||
                    enemy.y < -50 || enemy.y > gameHeight + 50) {
                    enemy.element.style.display = 'none';
                    enemies.splice(i, 1);
                    enemyPool.push(enemy);
                }
            }

            // 更新子弹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];

                // 移动子弹
                bullet.x += bullet.dx * bullet.speed;
                bullet.y += bullet.dy * bullet.speed;
                bullet.life++;

                bullet.element.style.left = bullet.x + 'px';
                bullet.element.style.top = bullet.y + 'px';

                // 检测子弹与敌人碰撞
                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet.x, bullet.y, 5,
                        enemy.x + 17.5, enemy.y + 17.5, 17.5)) {
                        // 移除敌人
                        enemy.element.style.display = 'none';
                        enemies.splice(j, 1);
                        enemyPool.push(enemy);

                        // 如果有 "击败回能" 升级
                        if (activeUpgrades['energyOnKill']) {
                            energy = Math.min(100, energy + 5);
                            updateEnergyBar();
                        }

                        hit = true;
                        break;
                    }
                }

                // 移除飞出屏幕或击中敌人的子弹
                if (hit || bullet.x < -20 || bullet.x > gameWidth + 20 ||
                    bullet.y < -20 || bullet.y > gameHeight + 20 || bullet.life > 300) {
                    bullet.element.style.display = 'none';
                    bullets.splice(i, 1);
                    bulletPool.push(bullet);
                }
            }

            // 保证碎片数量
            let minFragments = Math.min(3 + Math.floor(level / 2), 10);
            if (activeUpgrades['lessFragment']) {
                minFragments = Math.max(1, minFragments - 2);
            }
            while (fragments.length < minFragments) {
                spawnFragment();
            }

            // 生成新敌人（根据难度）
            enemySpawnTimer++;
            if (enemySpawnTimer > enemySpawnRate && enemies.length < 5 + level) {
                spawnEnemy();
                enemySpawnTimer = 0;
            }

            // Canvas清屏
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawFragments();
            drawEnemies();
            drawBullets();
            drawPlayer();

            requestAnimationFrame(gameLoop);
        }

        let eventsBound = false; // 标记事件是否已绑定

        // 绑定事件（确保只绑定一次）
        function bindEventsOnce() {
            if (eventsBound) return;
            document.addEventListener('keydown', (e) => {
                if (!gameRunning || gamePaused) return; // 暂停时不允许操作
                keys[e.key] = true;
                // 支持WASD（小写和大写）
                if (e.key === 'W' || e.key === 'w') keys['ArrowUp'] = true;
                if (e.key === 'A' || e.key === 'a') keys['ArrowLeft'] = true;
                if (e.key === 'S' || e.key === 's') keys['ArrowDown'] = true;
                if (e.key === 'D' || e.key === 'd') keys['ArrowRight'] = true;
            });
            document.addEventListener('keyup', (e) => {
                // keyup事件在暂停时也应该响应，以防止按键状态卡住
                keys[e.key] = false;
                // 支持WASD（小写和大写）
                if (e.key === 'W' || e.key === 'w') keys['ArrowUp'] = false;
                if (e.key === 'A' || e.key === 'a') keys['ArrowLeft'] = false;
                if (e.key === 'S' || e.key === 's') keys['ArrowDown'] = false;
                if (e.key === 'D' || e.key === 'd') keys['ArrowRight'] = false;
            });
            eventsBound = true;
        }

        // 事件监听
        startBtn.addEventListener('click', () => {
            storyScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            bindEventsOnce(); // 只绑定一次事件
            initGame();
            gameRunning = true;
            gamePaused = false;
            requestAnimationFrame(gameLoop);
        });

        restartBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                victoryScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                bindEventsOnce(); // 只绑定一次事件
                initGame();
                gameRunning = true;
                gamePaused = false;
                requestAnimationFrame(gameLoop);
            });
        });
    </script>
</body>

</html>
